<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.insigma.ordercenter.mapper.OrderMapper">

    <select id="queryOrderListPage" resultType="com.insigma.ordercenter.entity.vo.OrderListVO">
        SELECT
            o.order_id,
            o.order_no,
            o.order_status,
            sp.platform_name,
            o.create_time,
            o.review_time,
            so.send_time,
            so.receive_name,
            so.mobile_phone,
            o.error_reason,
            o.is_combined,
            o.is_hand_order
        FROM
            t_order o
        LEFT JOIN t_shop sp ON o.shop_id = sp.shop_id
        LEFT JOIN t_order_shipping_order_relation os ON o.order_id = os.order_id
        LEFT JOIN t_shipping_order so ON os.shipping_order_id = so.shipping_order_id
        WHERE
            so.send_time != NULL
        AND so.`status` = 2
        <if test="orderDTO.orderId != null and orderDTO.orderId != ''">
            AND o.order_id = #{orderDTO.orderId}
        </if>
        <if test="orderDTO.orderStatus != null">
            AND o.order_status in #{orderDTO.orderStatus}
        </if>
        <if test="orderDTO.orderNo != null and orderDTO.orderNo != ''">
            AND o.order_no = #{orderDTO.orderNo}
        </if>
        <if test="orderDTO.shippingOrderId != null and orderDTO.shippingOrderId != ''">
            AND so.shipping_order_id = #{orderDTO.shippingOrderId}
        </if>
        <if test="orderDTO.reviewTimeStart != null and orderDTO.reviewTimeStart != ''">
                AND o.review_time &gt;= #{orderDTO.reviewTimeStart} and o.review_time &lt;= #{orderDTO.reviewTimeEnd}
        </if>
        <if test="orderDTO.createTimeStart != null and orderDTO.createTimeStart != ''">
            AND o.createTime &gt;= #{orderDTO.createTimeStart} and o.createTime &lt;= #{orderDTO.createTimeStart}
        </if>
        <if test="orderDTO.sendTimeStart != null and orderDTO.sendTimeStart != ''">
            AND o.send_time &gt;= #{orderDTO.sendTimeStart} and o.send_time &lt;= #{orderDTO.sendTimeStart}
        </if>
        <if test="orderDTO.receiveName != null and orderDTO.receiveName != ''">
            AND so.receive_name = #{orderDTO.receiveName}
        </if>
        <if test="orderDTO.mobilePhone != null and orderDTO.mobilePhone != ''">
            AND so.mobile_phone = #{orderDTO.mobilePhone}
        </if>
        <if test="orderDTO.isCombined != null">
            AND o.is_combined = #{orderDTO.isCombined}
        </if>
    </select>

    <resultMap id="orderDetailMap" type="com.insigma.ordercenter.entity.vo.OrderDetailExamineVO">
        <id column="order_detail_id" property="orderDetailId"/>
        <result column="order_id" property="orderId"/>
        <result column="product_id" property="productId"/>
        <result column="product_sku" property="productSku"/>
        <result column="product_name" property="productName"/>
        <result column="product_price" property="productPrice"/>
        <result column="product_specs" property="productSpecs"/>
        <result column="unit" property="unit"/>
        <result column="amount" property="amount"/>
        <collection column="{productId=product_id}" property="warehouseExamineVOS" ofType="com.educiot.recruit.data.entity.Score" select="queryWarehouse"/>
    </resultMap>

    <resultMap id="WarehouseExamineMap" type="com.insigma.ordercenter.entity.vo.WarehouseExamineVO">
        <id column="warehouse_id" property="warehouseId"/>
        <result column="province" property="province"/>
        <result column="city" property="city"/>
        <result column="district" property="district"/>
        <result column="address" property="address"/>
        <result column="region_id" property="regionId"/>
        <result column="warehouse_no" property="warehouseNo"/>
        <result column="warehouse_name" property="warehouseName"/>
    </resultMap>

    <!--根据订单查询，订单明细和仓库列表-->
    <select id="queryOrderDetailList" resultMap="orderDetailMap">
        SELECT
            od.order_detail_id,
            od.product_sku,
            od.product_name,
            od.product_specs,
            od.unit,
            od.product_price,
            od.amount,
            od.product_id,
            od.order_id
        FROM
            t_order o
            LEFT JOIN t_order_detail od ON o.order_id = od.order_id
        WHERE
            o.order_id = #{orderId}
    </select>

    <!--根据仓库查询物流列表-->
    <select id="queryWarehouse" resultMap="WarehouseExamineMap">
        SELECT
            w.warehouse_id,
            w.province,
            w.city,
            w.district,
            w.address,
            w.region_id,
            w.warehouse_no,
            w.warehouse_name
        FROM
            t_product p
            LEFT JOIN t_warehouse_product_relation pr ON p.product_id = pr.product_id
            LEFT JOIN t_warehouse w ON pr.warehouse_id = w.warehouse_id
        WHERE
            p.product_id =#{productId}
    </select>

    <!--根据仓库关联出对应的物流信息-->
    <select id="queryExpressCompany" resultType="com.insigma.ordercenter.entity.vo.ExpressCompanyVO">
        SELECT
            ec.company_name,
            ec.company_no
        FROM
            t_express_warehouse_relation wr
            LEFT JOIN t_express_company ec ON wr.express_company_id = ec.express_company_id
        WHERE
            wr.warehouse_id = #{warehouseId}
    </select>

    <!--根据订单Id查询发货单列表信息-->
    <select id="cancelOrder" resultType="com.insigma.ordercenter.entity.vo.ShippingOrderCancelVO">
        SELECT
            so.shipping_order_id,
            so.warehouse_id,
            so.express_company_id,
            so.express_no,
            so.create_id,
            so.create_time,
            so.modify_id,
            so.modify_time,
            so.is_deleted,
            so.`status`,
            so.receive_name,
            so.mobile_phone,
            so.request_time,
            so.address,
            so.receive_remark,
            so.is_combined,
            so.is_refuse,
            so.shipping_order_no,
            so.send_time
        FROM
            t_detail_shipping_order_relation sor
            LEFT JOIN t_shipping_order so ON sor.shipping_order_id = so.shipping_order_id
        WHERE
            sor.order_id = #{orderId}
    </select>


    <!--查询订单和发货单列表，以及订单详细列表-->
    <resultMap id="orderResultMap" type="com.insigma.ordercenter.entity.vo.OrderListVO" >
        <id column="order_id" property="orderId" jdbcType="BIGINT" />
        <result column="order_no" property="orderNo" jdbcType="VARCHAR" />
        <result column="order_status" property="orderStatus" jdbcType="TINYINT" />
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
        <result column="shop_id" property="shopId" jdbcType="BIGINT" />
        <result column="consumer_name" property="consumerName" jdbcType="VARCHAR" />
        <result column="mobile_phone_order" property="mobilePhoneOrder" jdbcType="VARCHAR" />
        <result column="total_price" property="totalPrice" jdbcType="DECIMAL" />
        <result column="is_combined" property="isCombined" jdbcType="TINYINT" />
        <result column="origin_order_id" property="originOrderId" jdbcType="VARCHAR" />
        <result column="fee" property="fee" jdbcType="DECIMAL" />
        <result column="is_error" property="isError" jdbcType="TINYINT" />
        <result column="error_reason" property="errorReason" jdbcType="VARCHAR" />
        <result column="is_period" property="isPeriod" jdbcType="TINYINT" />
        <result column="period_order_id" property="periodOrderId" jdbcType="BIGINT" />
        <result column="review_time" property="reviewTime" jdbcType="TIMESTAMP" />
        <result column="is_hand_order" property="isHandOrder" jdbcType="TINYINT" />
        <result column="split_order" property="splitOrder" jdbcType="TINYINT" />
        <collection column="{orderId=order_id}" property="shippingOrderVOS" ofType="com.insigma.ordercenter.entity.vo.ShippingOrderVO" select="queryShippingOrderList"/>
    </resultMap>


    <resultMap id="shippingResultMap" type="com.insigma.ordercenter.entity.vo.ShippingOrderVO">
        <id column="shipping_order_id" jdbcType="BIGINT" property="shippingOrderId" />
        <result column="warehouse_id" jdbcType="BIGINT" property="warehouseId" />
        <result column="express_company_id" jdbcType="BIGINT" property="expressCompanyId" />
        <result column="express_no" jdbcType="VARCHAR" property="expressNo" />
        <result column="create_id" jdbcType="BIGINT" property="createId" />
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
        <result column="modify_id" jdbcType="BIGINT" property="modifyId" />
        <result column="modify_time" jdbcType="TIMESTAMP" property="modifyTime" />
        <result column="is_deleted" jdbcType="TINYINT" property="isDeleted" />
        <result column="status" jdbcType="TINYINT" property="status" />
        <result column="receive_name" jdbcType="VARCHAR" property="receiveName" />
        <result column="mobile_phone" jdbcType="VARCHAR" property="mobilePhone" />
        <result column="request_time" jdbcType="TIMESTAMP" property="requestTime" />
        <result column="address" jdbcType="VARCHAR" property="address" />
        <result column="receive_remark" jdbcType="VARCHAR" property="receiveRemark" />
        <result column="is_combined" jdbcType="TINYINT" property="isCombined" />
        <result column="is_refuse" jdbcType="TINYINT" property="isRefuse" />
        <result column="shipping_order_no" jdbcType="VARCHAR" property="shippingOrderNo" />
        <result column="send_time" jdbcType="TIMESTAMP" property="sendTime" />
        <result column="express_fee" jdbcType="DECIMAL" property="expressFee" />
        <result column="order_detail_id" jdbcType="BIGINT" property="orderDetailId" />
        <collection column="{shippingOrderId=shipping_order_id}" property="orderDetailVOS" ofType="com.insigma.ordercenter.entity.vo.OrderDetailVO" select="queryOrderDetailList"/>
    </resultMap>


    <resultMap id="shippingOrderDetailMap" type="com.insigma.ordercenter.entity.vo.OrderDetailVO">
        <id column="order_detail_id" property="orderDetailId"/>
        <result column="order_id" property="orderId"/>
        <result column="product_id" property="productId"/>
        <result column="product_sku" property="productSku"/>
        <result column="product_name" property="productName"/>
        <result column="product_price" property="productPrice"/>
        <result column="product_specs" property="productSpecs"/>
        <result column="unit" property="unit"/>
        <result column="amount" property="amount"/>
        <result column="total_price" property="totalPrice"/>
        <result column="is_gift" property="isGift"/>
    </resultMap>

    <select id="queryOrderById" resultMap="orderResultMap">
        SELECT
            o.order_id,
            o.order_no,
            o.order_status,
            o.create_time,
            o.shop_id,
            o.consumer_name,
            o.mobile_phone_order,
            o.total_price,
            o.is_combined,
            o.origin_order_id,
            o.fee,
            o.is_error,
            o.error_reason,
            o.is_period,
            o.period_order_id,
            o.review_time,
            o.is_hand_order,
            o.split_order
        FROM
            t_order o
        WHERE
            o.order_id = #{orderId}
    </select>

    <select id="queryShippingOrderList" resultMap="shippingResultMap">
        SELECT
            so.shipping_order_id,
            so.warehouse_id,
            so.express_company_id,
            so.express_no,
            so.create_id,
            so.create_time,
            so.modify_id,
            so.modify_time,
            so.is_deleted,
            so.`status`,
            so.receive_name,
            so.mobile_phone,
            so.request_time,
            so.address,
            so.receive_remark,
            so.is_combined,
            so.is_refuse,
            so.shipping_order_no,
            so.send_time,
            so.express_fee,
            so.order_detail_id
        FROM
            t_order_shipping_order_relation sor
            LEFT JOIN t_shipping_order so ON sor.shipping_order_id = so.shipping_order_id
        WHERE
            sor.order_id = #{orderId}
    </select>

    <select id="queryOrderDetailList" resultMap="shippingOrderDetailMap">
        SELECT
            od.order_detail_id,
            od.order_id,
            od.product_id,
            od.product_sku,
            od.product_name,
            od.product_price,
            od.product_specs,
            od.unit,
            od.quantity,
            od.total_price,
            od.is_gift
        FROM
            t_detail_shipping_order_relation sor
            LEFT JOIN t_order_detail od ON sor.order_detail_id = od.order_detail_id
        WHERE
            sor.shipping_order_id = #{shippingOrderId}
    </select>


    <!--根据订单ID查询原始订单信息-->
    <select id="queryOriginalOrderList" resultType="com.insigma.ordercenter.entity.vo.OriginalOrderVO">
        SELECT
            oo.original_order_id,
            oo.order_no,
            oo.create_time,
            oo.shop_id,
            oo.consumer_name,
            oo.mobile_phone,
            oo.total_price,
            oo.address,
            oo.remark,
            oo.order_id
        FROM
            t_original_order oo
        WHERE
            oo.order_id = #{orderId}
    </select>

</mapper>
